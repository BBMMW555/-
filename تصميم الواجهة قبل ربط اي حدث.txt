
# ------------------------ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª ------------------------
from PyQt5.QtWidgets import (QMainWindow, QWidget, QVBoxLayout, QHBoxLayout, 
   QLabel, QPushButton, QTextEdit, QLineEdit, 
   QFrame, QGraphicsDropShadowEffect, QMessageBox)
from PyQt5.QtCore import Qt, QEvent, QPoint, QTimer, QRect  # Ø£Ø¶ÙÙ†Ø§ QRect Ù‡Ù†Ø§
from PyQt5.QtGui import QColor, QPixmap

# ------------------------ ØªØ¹Ø±ÙŠÙ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ------------------------
class MainWindow(QMainWindow):
    def __init__(self):
        """
        ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚.
        """
        super().__init__()
        
        self.drag_pos = None   # Ù„ØªÙØ¹ÙŠÙ„ Ø®Ø§ØµÙŠØ© Ø§Ù„Ø³Ø­Ø¨ ÙˆØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù†Ø§ÙØ°Ø©.
        self.thinking_dialog = None # Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙÙƒÙŠØ± (ØªÙØ³ØªØ®Ø¯Ù… Ù„Ø§Ø­Ù‚Ù‹Ø§).
        self.icon_pos = None
        self.is_dragging = False
        self.dragging_from_icon = False
        self.mouse_offset = None  # Ø§Ù„Ø¥Ø²Ø§Ø­Ø© Ø¨ÙŠÙ† Ø§Ù„Ù…Ø§ÙˆØ³ ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©

        self.initUI()# ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UI).  

    
        # ------------------------ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ© Ù…Ø¤Ø¬Ù„Ø© ------------------------
        QTimer.singleShot(3000, self.welcome_message) 

    # ------------------------ ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ------------------------
    def initUI(self):
        # Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù†Ø§ÙØ°Ø©
        self.setWindowFlags(Qt.FramelessWindowHint | Qt.WindowStaysOnTopHint)
        self.setAttribute(Qt.WA_TranslucentBackground)
        self.setGeometry(100, 100, 400, 500)  # Ø­Ø¬Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠ

        # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
        self.central_widget = QWidget()
        self.setCentralWidget(self.central_widget)
        self.main_layout = QVBoxLayout(self.central_widget)
        self.main_layout.setContentsMargins(10, 10, 10, 10)  

        # Ø¥Ù†Ø´Ø§Ø¡ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        self.create_icon()  # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
        self.create_chat_frame()  # Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        self.create_input_area()  # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        self.create_control_buttons()  # Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…

        # Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        self.icon.installEventFilter(self)

    # ------------------------ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ------------------------
    def create_icon(self):
        """
        Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©.
        """
        self.icon = QLabel()
    
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
        pixmap = QPixmap("C:/Users/bassam/Desktop/bassam/assets/icon.png")
        if pixmap.isNull():
            # Ø¥Ø°Ø§ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©ØŒ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ…
            print("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù„Ù„Ø§ÙŠÙ‚ÙˆÙ†Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­ ")
            # Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø´ÙØ§ÙØ©
            pixmap = QPixmap(100, 100)
            pixmap.fill(Qt.transparent)
        else:
            # Ø¥Ø°Ø§ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ØŒ ØªØºÙŠÙŠØ± Ø­Ø¬Ù…Ù‡Ø§
            pixmap = pixmap.scaled(100, 100, Qt.KeepAspectRatio, Qt.    SmoothTransformation)
    
        # ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø¹Ù†ØµØ± QLabel
        self.icon.setPixmap(pixmap)
    
        # Ø¥Ø¶Ø§ÙØ© Ø®ØµØ§Ø¦Øµ Ø§Ù„ØªØµÙ…ÙŠÙ…
        self.icon.setAlignment(Qt.AlignCenter)
        self.icon.setStyleSheet("""
            QLabel {
                background: rgba(0, 0, 0, 0);
                border-radius: 50px;
                padding: 10px;
            }
        """)
        self.main_layout.addWidget(self.icon)
    # ------------------------ Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ------------------------
    def create_chat_frame(self):
        self.chat_frame = QFrame()
        self.chat_frame.setStyleSheet("""
            QFrame {
                background: rgba(255, 255, 255, 220);
                border: 1px solid #bdc3c7;
                border-radius: 15px;
            }
        """)
        #self.chat_frame.hide() # Ù…Ø®ÙÙŠ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        
        # Ø¥Ø¶Ø§ÙØ© Ø¸Ù„ Ù„Ù„Ø¥Ø·Ø§Ø±
        shadow = QGraphicsDropShadowEffect()
        shadow.setBlurRadius(5)
        shadow.setColor(QColor(0, 0, 0, 100))
        shadow.setOffset(0, 10)
        self.chat_frame.setGraphicsEffect(shadow)
        
        self.chat_layout = QVBoxLayout(self.chat_frame)
        self.chat_layout.setContentsMargins(10, 10, 10, 10)
        self.chat_layout.setSpacing(10)
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        self.chat_log = QTextEdit()
        self.chat_log.setReadOnly(True)
        self.chat_log.setStyleSheet("""
            QTextEdit {
                background: rgba(255, 255, 255, 200);
                border: 1px solid #bdc3c7;
                border-radius: 10px;
                padding: 10px;
                font-size: 14px;
            }
        """)
        self.chat_layout.addWidget(self.chat_log)
        self.main_layout.addWidget(self.chat_frame)

    # ------------------------ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø·Ù‚Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ------------------------
    def create_input_area(self):
        input_frame = QFrame()
        input_frame.setStyleSheet("""
            QFrame {
                background-color: rgba(255, 255, 255, 200);
                border: 1px solid gray;
                border-radius: 10px;
            }
        """)
        input_layout = QHBoxLayout(input_frame)
        input_layout.setSpacing(5)

        # Ø²Ø± Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
        self.talk_btn = QPushButton("ğŸ¤")
        self.talk_btn.setStyleSheet("""
            QPushButton {
                background-color: lightblue;
                border: 1px solid gray;
                border-radius: 5px;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #ffda03;
            }
        """)

        # Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Øµ
        self.input_field = QLineEdit()
        self.input_field.setPlaceholderText("Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...")
        self.input_field.setStyleSheet("""
            QLineEdit {
                background-color: rgba(255, 255, 255, 200);
                border: 1px solid gray;
                border-radius: 5px;
                padding: 5px;
            }
        """)

        # Ø²Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª
        self.file_btn = QPushButton("ğŸ“")
        self.file_btn.setStyleSheet("""
            QPushButton {
                background-color: lightblue;
                border: 1px solid gray;
                border-radius: 5px;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #ffda03;
            }
        """)

        # Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        self.send_btn = QPushButton("â¤")
        self.send_btn.setStyleSheet("""
            QPushButton {
                background-color: lightblue;
                border: 1px solid gray;
                border-radius: 5px;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #ffda03;
            }
        """)

        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
        input_layout.addWidget(self.talk_btn)
        input_layout.addWidget(self.input_field)
        input_layout.addWidget(self.file_btn)
        input_layout.addWidget(self.send_btn)
        self.chat_layout.addWidget(input_frame)

    # ------------------------ Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ------------------------
    def create_control_buttons(self):
        control_frame = QFrame()
        control_frame.setStyleSheet("""
            QFrame {
                background-color: rgba(255, 255, 255, 200);
                border: 1px solid gray;
                border-radius: 10px;
            }
        """)
        control_layout = QHBoxLayout(control_frame)
        control_layout.setSpacing(50)

        # Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
        self.close_btn = QPushButton("Ø¥ØºÙ„Ø§Ù‚")
        self.close_btn.setFixedSize(50, 30)
        self.close_btn.setToolTip("Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©")
        self.close_btn.setStyleSheet("""
            QPushButton {
                background-color: lightblue;
                border: 1px solid gray;
                border-radius: 5px;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #ffda03;
            }
        """)
        self.close_btn.clicked.connect(self.close)

        # Ø²Ø± Ø§Ù„ØªØ·ÙˆÙŠØ±
        self.update_btn = QPushButton("ğŸš€ ØªØ·ÙˆÙŠØ±")
        self.update_btn.setFixedSize(60, 30)
        self.update_btn.setToolTip("ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ±")
        self.update_btn.setStyleSheet("""
            QPushButton {
                background-color: lightblue;
                border: 1px solid gray;
                border-radius: 5px;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #ffda03;
            }
        """)

        # Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        self.settings_btn = QPushButton("âš™")
        self.settings_btn.setToolTip("Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª")
        self.settings_btn.setFixedSize(40, 30)
        self.settings_btn.setStyleSheet("""
            QPushButton {
                background-color: lightblue;
                border: 1px solid gray;
                border-radius: 5px;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #ffda03;
            }
        """)

        # Ø²Ø± Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ‚
        self.think_btn = QPushButton("ğŸ’­ ØªÙÙƒÙŠØ± Ø¹Ù…ÙŠÙ‚")
        self.think_btn.setToolTip("ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…")
        self.think_btn.setFixedSize(100, 30)
        self.think_btn.setStyleSheet("""
            QPushButton {
                background-color: lightblue;
                border: 1px solid gray;
                border-radius: 5px;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #ffda03;
            }
        """)
        self.think_btn.clicked.connect(self.show_thinking_dialog)

        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        control_layout.addWidget(self.close_btn)
        control_layout.addWidget(self.update_btn)
        control_layout.addWidget(self.settings_btn)
        control_layout.addWidget(self.think_btn)
        self.chat_layout.addWidget(control_frame)

  
    # ------------------------ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø§ÙˆØ³ ---------------------
    def eventFilter(self, obj, event):
        if obj == self.icon:  # Ø§Ù„ØªØ¹Ø§Ù…Ù„ ÙÙ‚Ø· Ù…Ø¹ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
            if event.type() == QEvent.Enter:
                # ØªÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØºÙ„Ù‚Ø© ÙˆÙ„ÙŠØ³ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø³Ø­Ø¨
                if not self.chat_frame.isVisible() and not self.is_dragging:
                    self.chat_frame.show()
                    self.resize(400, 500)
                return True
        return super().eventFilter(obj, event)
        
    def mousePressEvent(self, event):
        if event.button() == Qt.LeftButton:
            icon_rect = QRect(self.icon.pos(), self.icon.size())
            if icon_rect.contains(event.pos()):
                self.dragging_from_icon = True  # ØªÙ… Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
            self.is_dragging = True
            self.drag_pos = event.globalPos()
            event.accept()
    
    def mouseMoveEvent(self, event):
        if event.buttons() & Qt.LeftButton and self.drag_pos:
            delta = event.globalPos() - self.drag_pos
            self.move(self.pos() + delta)
            self.drag_pos = event.globalPos()
            
            # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø­Ø¨ Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø©
            if self.dragging_from_icon and self.chat_frame.isVisible():
                self.chat_frame.hide()
            
            # ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
            self.icon.move(self.width()//2 - self.icon.width()//2, 10)
            event.accept()
    
    def mouseReleaseEvent(self, event):
        self.is_dragging = False
        self.dragging_from_icon = False  # Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©
        self.drag_pos = None
        event.accept()

    
    
    #     # ------------------------ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ© ------------------------
    def welcome_message(self):
        """Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"""
        welcome_text = (
            "Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø£Ù†Ø§ Ù…Ø§Ù†ÙŠØŒ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ.\n"
            "ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ"
        )
        self.update_chat_display(welcome_text, "Ø§Ù„Ù†Ø¸Ø§Ù…")

    def update_chat_display(self, message, sender):
        """ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©"""
        if sender == "Ø§Ù„Ù†Ø¸Ø§Ù…":
            self.chat_log.append(f'<div style="color: #27ae60;"><b>{sender}:</b> {message}</div>')
        else:
            self.chat_log.append(f'<div style="color: #2980b9;"><b>{sender}:</b> {message}</div>')

    # ------------------------ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø²Ø±Ø§Ø± ------------------------
    def send_message(self):
        """Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
        message = self.input_field.text()
        if message:
            self.chat_log.append(f'<div style="color: #2980b9;"><b>Ø£Ù†Øª:</b> {message}</div>')
            self.input_field.clear()

    def show_thinking_dialog(self):
        """Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…"""
        user_input = self.input_field.text().strip()
        if not user_input:
            QMessageBox.warning(self, "ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ù„Ù„ØªØ­Ù„ÙŠÙ„.")
            return
        # ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙÙƒÙŠØ± Ù‡Ù†Ø§


        





if __name__ == "__main__":
    from PyQt5.QtWidgets import QApplication
    import sys

    app = QApplication(sys.argv)
    window = MainWindow()
    window.show()
    sys.exit(app.exec_())